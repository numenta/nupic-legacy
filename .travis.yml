branches:
  except:
    - gh-pages

language: cpp

os:
  - linux
  - osx

compiler:
  - clang
  - gcc

env:
  global:
    - NUPIC=$TRAVIS_BUILD_DIR
    - NTA=$HOME/nta/eng
    - PATH=$TRAVIS_BUILD_DIR/python/bin:$PATH
  matrix:
    - PY_VER=2.7
    - PY_VER=2.6

matrix:
  # This excludes OSX builds from the build matrix for gcc and Python 2.6
  exclude:
    - os: osx
      env: PY_VER=2.6
    - os: osx
      compiler: gcc

# Successful builds are archived and uploaded to S3 for regression testing.
before_deploy:
  - ${TRAVIS_BUILD_DIR}/ci/before-deploy.sh

deploy:
  provider: s3
  access_key_id: AKIAIGHYSEHV3WFKOWNQ
  secret_access_key:
    secure: "ONG00ZCPpfU/nugFiON3K2q8IMk3nB/aAUj2Ggjf1z0CJS/cvnfIexmJhe+DJCccoco2l5gpiqp7gweH5vXEcyrzTt1I3Z+iFNas2cQ/wF3LjW0NcbdGeC9NN9kGIoOvr8g6L66CUvazYoirgbJO01ktm7LVNeGS3Q1pk36Vp10="
  bucket: artifacts.numenta.org
  region: us-west-2
  local-dir: "${TRAVIS_BUILD_DIR}/build/archive"
  upload-dir: "numenta/nupic/${TRAVIS_COMMIT}"
  skip_cleanup: true
  # Only deploy on master from one build job: linux, clang, python 2.7.
  on:
    branch: master
    condition:
      - "$TRAVIS_OS_NAME == linux"
      - "$PY_VER == 2.7"
      - "$CC == clang"

git:
  submodules: false

notifications:
  irc:
    channels:
      - "irc.freenode.net#nupic-hackers"
  webhooks: http://issues.numenta.org:8081/travis

before_install:
  # Set the virtualenv activation location
  - "if [ $TRAVIS_OS_NAME = 'linux']; then export VENV_ACTIVATE=${TRAVIS_BUILD_DIR}/bin/activate; fi"
  - "if [ $TRAVIS_OS_NAME = 'osx']; then export VENV_ACTIVATE=${TRAVIS_BUILD_DIR}/nupic-darwin64/bin/activate; fi"
  # Runs an OS-specific script.
  - cd ${TRAVIS_BUILD_DIR}
  - ./ci/${TRAVIS_OS_NAME}-before-install.sh
  - source ${VENV_ACTIVATE}

install:
  - "mkdir -p $TRAVIS_BUILD_DIR/build/scripts"
  - "cd $TRAVIS_BUILD_DIR/build/scripts"
  # Verify cmake version.
  - "cmake --version"
  # Verify python version.
  - "python --version"
  # Build NuPIC using the OS-specific script.
  - ${TRAVIS_BUILD_DIR}/ci/${TRAVIS_OS_NAME}-install.sh
  - "make -j3"
  - "cd"

script:
  - "cd $TRAVIS_BUILD_DIR/build/scripts"
  # Runs legacy binary Python tests.
  - "make tests_pyhtm"
  # Runs all Python unit and integration tests.
  - "make tests_run_all"
  - "cd"

  # run all example files
  - ${TRAVIS_BUILD_DIR}/ci/run-examples.sh

after_success:
  - "if [ $TRAVIS_OS_NAME = 'linux' ] && [ $PY_VER = '2.7' ] && [ $CC = 'clang' ]; then ${TRAVIS_BUILD_DIR}/ci/report-coverage.sh; fi"
